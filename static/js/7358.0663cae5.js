"use strict";(self["webpackChunkonepic"]=self["webpackChunkonepic"]||[]).push([[7358],{47358:function(t,e,i){i.r(e),i.d(e,{default:function(){return C}});var a=i(61445),r=i(93622),s=i(92454),o=i(18105),h=i(58006),n=(i(94315),i(15055),i(77623)),p=i(85654),d=i(74952),l=i(54572),u=i(31885),g=i(61717),c=i(30482),m=i(31698),y=i(12799),_=i(61804);const f=t=>{let e=class extends t{initialize(){this.exportImageParameters=new _.R({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),this.commitProperty("floors"),(this._get("exportImageVersion")||0)+1}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return(0,a._)([(0,h.Cb)()],e.prototype,"exportImageParameters",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],e.prototype,"floors",null),(0,a._)([(0,h.Cb)({readOnly:!0})],e.prototype,"exportImageVersion",null),(0,a._)([(0,h.Cb)()],e.prototype,"layer",void 0),(0,a._)([(0,h.Cb)()],e.prototype,"suspended",void 0),(0,a._)([(0,h.Cb)(y.qG)],e.prototype,"timeExtent",void 0),e=(0,a._)([(0,n.j)("esri.views.layers.MapImageLayerView")],e),e};var x=i(42769),v=i(23142),w=i(98967);let b=class extends(f((0,x.Z)((0,l.y)(m.Z)))){constructor(){super(...arguments),this._highlightGraphics=new p.J,this._updateHash=""}fetchPopupFeatures(t,e){return this._popupHighlightHelper.fetchPopupFeatures(t,e)}update(t){const e=`${this.exportImageVersion}/${t.state.id}/${t.pixelRatio}/${t.stationary}`;this._updateHash!==e&&(this._updateHash=e,this.strategy.update(t).catch((t=>{(0,s.D_)(t)||r.Z.getLogger(this.declaredClass).error(t)})),t.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(t.state.resolution)),this._highlightView.processUpdate(t)}attach(){const{imageMaxWidth:t,imageMaxHeight:e,version:i}=this.layer,a=i>=10.3,r=i>=10;this._bitmapContainer=new d.c,this.container.addChild(this._bitmapContainer),this._highlightView=new u.Z({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new g.Z(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new v.VF({createFetchPopupFeaturesQueryGeometry:(t,e)=>(0,w.K)(t,e,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(t,e)=>{this._highlightView.graphicUpdateHandler({graphic:t,property:e})},layerView:this,updatingHandles:this.updatingHandles}),this.strategy=new c.Z({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:e,imageRotationSupported:a,imageNormalizationSupported:r,hidpi:!0}),this.addAttachHandles((0,o.YP)((()=>this.exportImageVersion),(()=>this.requestUpdate()))),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}async doRefresh(){this._updateHash="",this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,e,i,a){return this.layer.fetchImage(t,e,i,{timeExtent:this.timeExtent,floors:this.floors,...a})}fetchImageBitmap(t,e,i,a){return this.layer.fetchImageBitmap(t,e,i,{timeExtent:this.timeExtent,floors:this.floors,...a})}highlight(t){return this._popupHighlightHelper.highlight(t)}};(0,a._)([(0,h.Cb)()],b.prototype,"strategy",void 0),(0,a._)([(0,h.Cb)()],b.prototype,"updating",void 0),b=(0,a._)([(0,n.j)("esri.views.2d.layers.MapImageLayerView2D")],b);const C=b},30482:function(t,e,i){i.d(e,{Z:function(){return C}});i(57658);var a=i(61445),r=i(92698),s=(i(81653),i(92454)),o=i(58006),h=(i(94315),i(15055),i(77623)),n=i(74440),p=i(54597),d=i(86052);const l=Math.PI/180;function u(t){return t*l}function g(t,e){const i=u(e.rotation),a=Math.abs(Math.cos(i)),r=Math.abs(Math.sin(i)),[s,o]=e.size;return t[0]=Math.round(o*r+s*a),t[1]=Math.round(o*a+s*r),t}function c(t,e,i,a){const[r,s]=e,[o,h]=a,n=.5*i;return t[0]=r-n*o,t[1]=s-n*h,t[2]=r+n*o,t[3]=s+n*h,t}var m=i(15347),y=i(86491),_=i(93752);const f=(0,n.Ue)(),x=[0,0],v=new _.Z(0,0,0,0),w={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let b=class extends r.Z{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w.hidpi,this.imageMaxWidth=w.imageMaxWidth,this.imageMaxHeight=w.imageMaxHeight,this.imageRotationSupported=w.imageRotationSupported,this.imageNormalizationSupported=w.imageNormalizationSupported,this.update=(0,s.Ds)((async(t,e)=>{if((0,s.k_)(e),!t.stationary||this.destroyed)return;const i=t.state,a=(0,p.C5)(i.spatialReference),r=this.hidpi?t.pixelRatio:1,o=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0],h=this.imageMaxWidth??0,n=this.imageMaxHeight??0;o?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):g(x,i);const d=Math.floor(x[0]*r)>h||Math.floor(x[1]*r)>n,l=a&&(i.extent.xmin<a.valid[0]||i.extent.xmax>a.valid[1]),u=!this.imageNormalizationSupported&&l,c=!d&&!u,m=this.imageRotationSupported?i.rotation:0,y=this.container.children.slice();if(c){const t=o?i.paddedViewState.center:i.center;this._imagePromise&&console.error("Image promise was not defined!"),this._imagePromise=this._singleExport(i,x,t,i.resolution,m,r,e)}else{let t=Math.min(h,n);u&&(t=Math.min(i.worldScreenWidth,t)),this._imagePromise=this._tiledExport(i,t,r,e)}try{const t=await this._imagePromise??[];(0,s.k_)(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of y)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(v){this._imagePromise=null,(0,s.r9)(v)}}),5e3),this.updateExports=(0,s.Ds)((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=(0,s.as)(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,a,r,o){const h=await this.fetchSource(t,Math.floor(e*r),Math.floor(i*r),{rotation:a,pixelRatio:r,signal:o});(0,s.k_)(o);const n=new m.eY(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});return n.x=t.xmin,n.y=t.ymax,n.resolution=t.width/e,n.rotation=a,n.pixelRatio=r,n.opacity=0,this.container.addChild(n),await n.setSourceAsync(h,o),(0,s.k_)(o),n}async _singleExport(t,e,i,a,r,s,o){c(f,i,a,e);const h=(0,n.HH)(f,t.spatialReference);return[await this._export(h,e[0],e[1],r,s,o)]}_tiledExport(t,e,i,a){const r=d.Z.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new y.Z(r),o=s.getTileCoverage(t);if(!o)return null;const h=[];return o.forEach(((r,o,p,d)=>{v.set(r,o,p,0),s.getTileBounds(f,v);const l=(0,n.HH)(f,t.spatialReference);h.push(this._export(l,e,e,0,i,a).then((t=>(0!==d&&(v.set(r,o,p,d),s.getTileBounds(f,v),t.x=f[0],t.y=f[3]),t))))})),Promise.all(h)}};(0,a._)([(0,o.Cb)()],b.prototype,"_imagePromise",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"bitmaps",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"container",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"fetchSource",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"hidpi",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"imageMaxWidth",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"imageMaxHeight",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"imageRotationSupported",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"imageNormalizationSupported",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"requestUpdate",void 0),(0,a._)([(0,o.Cb)()],b.prototype,"updating",null),b=(0,a._)([(0,h.j)("esri.views.2d.layers.support.ExportStrategy")],b);const C=b}}]);